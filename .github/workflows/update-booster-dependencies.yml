name: Update Booster Dependencies

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get latest Node.js LTS version
        id: node-version
        run: |
          # Get latest Node.js LTS version from nodejs.org API
          LATEST_LTS=$(curl -s https://nodejs.org/dist/index.json | jq -r '[.[] | select(.lts != false)] | .[0].version' | sed 's/v//')
          echo "latest=$LATEST_LTS" >> $GITHUB_OUTPUT
          echo "Latest Node.js LTS: $LATEST_LTS"

      - name: Get latest pnpm version
        id: pnpm-version
        run: |
          # Get latest pnpm version from npm registry
          LATEST_PNPM=$(npm view pnpm version)
          echo "latest=$LATEST_PNPM" >> $GITHUB_OUTPUT
          echo "Latest pnpm: $LATEST_PNPM"

      - name: Check PHP package updates
        id: php-updates
        run: |
          # Parse composer.json and check each package on Packagist API
          cd booster

          echo "Checking PHP packages for updates..."
          HAS_UPDATES=false

          # Read packages from composer.json
          PACKAGES=$(jq -r '.["require-dev"] | keys[]' composer.json)

          for PACKAGE in $PACKAGES; do
            CURRENT_VERSION=$(jq -r ".\"require-dev\".\"$PACKAGE\"" composer.json | sed 's/[\^~]//')

            # Get latest stable version from Packagist v1 API
            LATEST_VERSION=$(curl -s "https://packagist.org/packages/$PACKAGE.json" | \
              jq -r '.package.versions | to_entries | map(select(.key | test("^[0-9]"))) | .[0].key' 2>/dev/null || echo "")

            if [ -n "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "null" ]; then
              echo "$PACKAGE: $CURRENT_VERSION -> $LATEST_VERSION"

              # Simple version comparison
              if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
                HAS_UPDATES=true
              fi
            fi
          done

          echo "has_updates=$HAS_UPDATES" >> $GITHUB_OUTPUT

      - name: Check NPM package updates
        id: npm-updates
        working-directory: booster
        run: |
          # Check for outdated NPM packages using npm registry API
          echo "Checking NPM packages for updates..."
          HAS_UPDATES=false

          # Read packages from package.json
          PACKAGES=$(jq -r '.devDependencies | keys[]' package.json)

          for PACKAGE in $PACKAGES; do
            CURRENT_VERSION=$(jq -r ".devDependencies.\"$PACKAGE\"" package.json | sed 's/[\^~]//')

            # Get latest version from NPM registry
            LATEST_VERSION=$(curl -s "https://registry.npmjs.org/$PACKAGE/latest" | \
              jq -r '.version' 2>/dev/null || echo "")

            if [ -n "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "null" ]; then
              echo "$PACKAGE: $CURRENT_VERSION -> $LATEST_VERSION"

              # Simple version comparison
              if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
                HAS_UPDATES=true
              fi
            fi
          done

          echo "has_updates=$HAS_UPDATES" >> $GITHUB_OUTPUT

      - name: Update Node.js version in DDEV config
        run: |
          CURRENT_NODE=$(grep 'nodejs_version:' booster/.ddev/config.yaml | sed -n 's/^nodejs_version: "\([^"]*\)".*/\1/p')
          LATEST_NODE="${{ steps.node-version.outputs.latest }}"

          echo "Current Node.js: $CURRENT_NODE"
          echo "Latest Node.js LTS: $LATEST_NODE"

          if [ "$CURRENT_NODE" != "$LATEST_NODE" ]; then
            sed -i "s/nodejs_version: \"$CURRENT_NODE\"/nodejs_version: \"$LATEST_NODE\"/" booster/.ddev/config.yaml
            echo "updated=true" >> $GITHUB_ENV
            echo "Updated Node.js from $CURRENT_NODE to $LATEST_NODE"
          else
            echo "Node.js version is already up to date"
          fi

      - name: Update @types/node if Node.js version changed
        if: env.updated == 'true'
        working-directory: booster
        run: |
          LATEST_NODE="${{ steps.node-version.outputs.latest }}"
          NODE_MAJOR=$(echo "$LATEST_NODE" | cut -d. -f1)
          echo "Updating @types/node to ^$NODE_MAJOR..."

          # Update package.json directly using jq
          jq ".devDependencies[\"@types/node\"] = \"^$NODE_MAJOR\"" package.json > package.json.tmp
          mv package.json.tmp package.json

          echo "Updated @types/node to version ^$NODE_MAJOR"

      - name: Update pnpm packageManager
        working-directory: booster
        run: |
          CURRENT_PNPM=$(jq -r '.packageManager' package.json | sed 's/pnpm@//')
          LATEST_PNPM="${{ steps.pnpm-version.outputs.latest }}"

          echo "Current pnpm: $CURRENT_PNPM"
          echo "Latest pnpm: $LATEST_PNPM"

          if [ "$CURRENT_PNPM" != "$LATEST_PNPM" ]; then
            jq ".packageManager = \"pnpm@$LATEST_PNPM\"" package.json > package.json.tmp
            mv package.json.tmp package.json
            echo "updated=true" >> $GITHUB_ENV
            echo "Updated pnpm from $CURRENT_PNPM to $LATEST_PNPM"
          else
            echo "pnpm version is already up to date"
          fi

      - name: Update PHP dependencies
        if: steps.php-updates.outputs.has_updates == 'true'
        working-directory: booster
        run: |
          # Update PHP package versions in composer.json using Packagist v1 API
          PACKAGES=$(jq -r '.["require-dev"] | keys[]' composer.json)

          for PACKAGE in $PACKAGES; do
            # Get latest stable version from Packagist
            LATEST_VERSION=$(curl -s "https://packagist.org/packages/$PACKAGE.json" | \
              jq -r '.package.versions | to_entries | map(select(.key | test("^[0-9]"))) | .[0].key' 2>/dev/null || echo "")

            if [ -n "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "null" ]; then
              echo "Updating $PACKAGE to ^$LATEST_VERSION"

              # Update composer.json with new version constraint (preserve formatting with --indent 1 for tabs)
              jq --indent 1 --tab ".\"require-dev\".\"$PACKAGE\" = \"^$LATEST_VERSION\"" composer.json > composer.json.tmp
              mv composer.json.tmp composer.json
            fi
          done

          echo "updated=true" >> $GITHUB_ENV

      - name: Update NPM dependencies if needed
        if: env.updated == 'true' && steps.npm-updates.outputs.has_updates == 'true'
        working-directory: booster
        run: |
          echo "Updating NPM packages to latest versions..."

          # Read all dev dependencies
          PACKAGES=$(jq -r '.devDependencies | keys[]' package.json)

          for PACKAGE in $PACKAGES; do
            # Get latest version from NPM registry
            LATEST_VERSION=$(curl -s "https://registry.npmjs.org/$PACKAGE/latest" | \
              jq -r '.version' 2>/dev/null || echo "")

            if [ -n "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "null" ]; then
              echo "Updating $PACKAGE to $LATEST_VERSION"

              # Update package.json with latest version (using ^ prefix)
              jq ".devDependencies[\"$PACKAGE\"] = \"^$LATEST_VERSION\"" package.json > package.json.tmp
              mv package.json.tmp package.json
            fi
          done

          echo "NPM package versions updated in package.json"
          echo "Note: pnpm-lock.yaml NOT updated - run 'pnpm install' locally to test"

      - name: Generate update summary
        if: env.updated == 'true'
        id: summary
        run: |
          echo "## ðŸ“¦ Dependency Updates" > update-summary.md
          echo "" >> update-summary.md
          echo "This PR updates booster dependencies to their latest versions." >> update-summary.md
          echo "" >> update-summary.md

          # Node.js changes
          CURRENT_NODE=$(git diff HEAD booster/.ddev/config.yaml | grep -A1 "^-nodejs_version" | tail -1 | sed 's/.*"\(.*\)"/\1/' || echo "")
          NEW_NODE="${{ steps.node-version.outputs.latest }}"
          if [ -n "$CURRENT_NODE" ] && [ "$CURRENT_NODE" != "$NEW_NODE" ]; then
            echo "### Node.js" >> update-summary.md
            echo "- Updated from \`$CURRENT_NODE\` to \`$NEW_NODE\`" >> update-summary.md
            echo "- Updated \`@types/node\` to match" >> update-summary.md
            echo "" >> update-summary.md
          fi

          # pnpm changes
          if git diff --quiet HEAD booster/package.json; then
            :
          else
            echo "### Package Manager" >> update-summary.md
            echo "- Updated pnpm to \`${{ steps.pnpm-version.outputs.latest }}\`" >> update-summary.md
            echo "" >> update-summary.md
          fi

          # PHP package changes
          if [ "${{ steps.php-updates.outputs.has_updates }}" == "true" ]; then
            echo "### PHP Packages" >> update-summary.md

            # Get current versions from git
            git diff HEAD booster/composer.json > /tmp/composer-diff.txt || true

            if [ -s /tmp/composer-diff.txt ]; then
              # Parse the diff to extract package names and versions
              grep '^[+-]' /tmp/composer-diff.txt | grep -v '^[+-][+-][+-]' | grep '"' | while IFS= read -r line; do
                if [[ $line =~ \"([^\"]+)\":[[:space:]]*\"([^\"]+)\" ]]; then
                  PACKAGE="${BASH_REMATCH[1]}"
                  VERSION="${BASH_REMATCH[2]}"

                  if [[ $line =~ ^- ]]; then
                    OLD_VERSION="$VERSION"
                  elif [[ $line =~ ^+ ]]; then
                    NEW_VERSION="$VERSION"
                    if [ -n "$OLD_VERSION" ]; then
                      echo "- \`$PACKAGE\`: $OLD_VERSION â†’ $NEW_VERSION" >> update-summary.md
                      OLD_VERSION=""
                    fi
                  fi
                fi
              done

              # If no changes were parsed, check if there are any at all
              if ! grep -q "^- \`" update-summary.md 2>/dev/null; then
                echo "- Updated to latest versions" >> update-summary.md
              fi
              echo "" >> update-summary.md
            else
              echo "- No changes detected" >> update-summary.md
              echo "" >> update-summary.md
            fi
          fi

          # NPM package changes
          if [ "${{ steps.npm-updates.outputs.has_updates }}" == "true" ]; then
            echo "### NPM Packages (package.json)" >> update-summary.md
            echo "Updated to latest versions. See \`package.json\` for details." >> update-summary.md
            echo "" >> update-summary.md
          fi

          echo "### Files Changed" >> update-summary.md
          echo "- \`booster/.ddev/config.yaml\` (Node.js version)" >> update-summary.md
          echo "- \`booster/package.json\` (pnpm, @types/node, devDependencies)" >> update-summary.md
          echo "- \`booster/composer.json\` (PHP package versions)" >> update-summary.md

          cat update-summary.md

      - name: Create Pull Request
        if: env.updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(deps): update booster dependencies

            - Update Node.js to ${{ steps.node-version.outputs.latest }}
            - Update pnpm to ${{ steps.pnpm-version.outputs.latest }}
            - Update PHP packages to latest versions
            - Update NPM packages to latest versions
          branch: update-booster-dependencies
          delete-branch: true
          title: 'chore(deps): Update Booster Dependencies'
          body-path: update-summary.md
          labels: |
            dependencies
            automation
            booster
          assignees: ${{ github.repository_owner }}
          draft: false
          add-paths: |
            booster/.ddev/config.yaml
            booster/package.json
            booster/composer.json

      - name: No updates needed
        if: env.updated != 'true'
        run: |
          echo "âœ… All dependencies are up to date!"
          echo "No pull request created."
